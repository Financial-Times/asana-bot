<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" media="all" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
<link rel="stylesheet" th:href="@{/css/report.css}" href="../../css/report.css"/>
<link rel="shortcut icon" href="http://im.ft-static.com/m/icons/favicon.ico" type="image/x-icon" />

<!-- Origami imports -->
<link rel="stylesheet" href="//build.origami.ft.com/bundles/css?modules=o-header@^3.0.6,o-ft-icons@^2.3.7"/>
<script src="//build.origami.ft.com/bundles/js?modules=o-header@^3.0.6"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<head>
    <title>Conference report</title>
</head>
<body>
<!-- FT Style Header - http://registry.origami.ft.com/components/o-header@3.0.6 -->
<header data-o-component="o-header" class="o-header">
    <div class="o-header__container">
        <div class="o-header__inner">
            <div class="o-header__primary">
                <div class="o-header__primary__left">
                    <div class="o-header__logo o-header__logo--ft">
                        <a href="http://www.ft.com/">
                            <abbr title="Financial Times">FT</abbr>
                        </a>
                        <a href="">
                            <h1 class="o-header__title">Asana Reports</h1>
                        </a>
                    </div>
                </div>
                <div class="o-header__primary__center"><h2 class="o-header__tagline">
                    <!-- could add a secondary title here --></h2></div>
            </div>
        </div>
    </div>
</header>

<div th:if="${criteria.team}" criteriaclass="container-fluid">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Select Report Type</h3>
        </div>

        <div class="panel-body">

            <form id="reportCriteriaForm" class="form-inline" action="#" method="post"
                  th:action="@{/}"
                  th:object="${criteria}">

                <!-- Validation errors -->
                <div th:if="${#fields.hasErrors('*')}"
                     class="alert alert-error">
                    <p th:each="error : ${#fields.errors('*')}"
                       th:text="${error}">
                        Validation error
                    </p>
                </div>
                <!-- Report select -->
                <div class="form-group">
                    <label class="control-label" for="reportTypeSelect">Report</label>

                    <select id="reportTypeSelect" name="reportType" class="form-control"
                            th:field="*{reportType}">
                        <option th:each="rt : ${reportTypes}" th:value="${rt}" th:text="${rt.format()}">Report</option>
                    </select>

                </div>
                <!-- Desk select -->
                <div class="form-group">
                    <label class="control-label" for="teamSelect">Desk</label>
                    <select id="teamSelect" name="team" class="form-control"
                            th:field="*{team}">
                        <option th:each="team : ${teams}" th:value="${team.key}" th:text="${team.key}">Team</option>
                    </select>
                </div>
                <!-- Project select -->
                <div class="form-group" id="projects-holder" th:classappend="${teams['__${criteria.team}__']?.size() > 1} ? '' : 'hidden'">
                    <label class="control-label" for="projectSelect">Project</label>
                    <select id="projectSelect" name="project" class="form-control"
                            th:field="*{project.id}">
                        <option th:each="project : ${teams['__${criteria.team}__']}" th:value="${project.id}" th:text="${project.name}">Project</option>
                    </select>
                </div>

                <!-- Submit -->
                <input type="submit" id="submitButton" name="submitButton" class="btn btn-primary" value="Submit"/>
            </form>

        </div>
    </div>
</div>

<div th:unless="${criteria.team}" criteriaclass="container-fluid">
    <span>You need to belong to a team to use this application</span>
</div>
<div class="clearfix"></div>

<div th:if="${report}" class="container-fluid">
    <div class="panel panel-default">

        <div class="panel-heading">
            <h3 class="panel-title">Report Output <a class="btn btn-default" role="button"
                                                     href="javascript:window.print()">Print this report</a></h3>
        </div>
        <div class="panel-body printable">

            <header>
                <img src="http://im.test.ft-static.com/m/img/masthead_main.jpg" width="115px"/>
                <span th:text="${criteria.getReportType().format()} + '\'s conference report ' + ${reportDate}">title</span>
                <span th:text="'(' + ${criteria.getTeam()} + ' desk)'">Selected team</span>
                <span th:if="${teams['__${criteria.team}__'].size() > 1}" th:text="'(' + ${criteria.getProject().getName()} + ' project)'">Multi-project team</span>
            </header>

            <div>
                <th:block th:each="tt: ${report.tagTasks}">
                    <span th:if="${report.groupByTags}" class="tags" th:text="${tt.key}">Tag</span>
                    <table class="table table-condensed">
                        <tbody th:if="${#lists.isEmpty(tt.value)}" th:text="None"></tbody>
                        <tbody th:unless="${#lists.isEmpty(tt.value)}">
                        <tr th:each="task: ${tt.value}">
                            <td>
                                <div>
                                    <span th:class="${task.important} ? 'o-ft-icons-icon o-ft-icons-icon--arrow-upwards'"></span>
                                    <b th:text="${task.name}" ></b>
                                    <span th:unless="${#lists.isEmpty(task.tags)}"
                                          th:text="${#strings.listJoin(task.tags,', ')}"
                                          class="tags_sm">Secondary tags</span>
                                </div>
                                <span th:if="${task.notes}" th:utext="${#strings.replace( #strings.escapeXml(task.notes),T(java.lang.System).getProperty('line.separator'),'&lt;br /&gt;')}" class="notes"></span>
                                <ul>
                                    <li th:each="subtask : ${task.subtasks}">
                                        <span th:text="${subtask.name}">Subtask name</span>
                                        <span th:if="${subtask.completed}" class="complete">&#10003;</span>
                                    </li>
                                </ul>

                            </td>
                        </tr>
                        </tbody>
                    </table>
                </th:block>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    /*<![CDATA[*/

    var desks = /*[[${teams}]]*/ null;

    function populateSelect(el, items) {
        el.options.length = 0;

        $.each(items, function () {
            el.options[el.options.length] = new Option(this.name, this.id);
        });
    }

    $(document).ready(function () {
        $('#teamSelect').bind('change', function() {
            var teamName = this.value;
            var projects = desks[teamName];
            //Descending order
            projects.sort(function(first, second){
                return first.primary ? -1 : (second.primary ? 1 : 0)
            });

            populateSelect($('#projectSelect').get(0), projects);
            var container = $('#projects-holder');
            if (projects.length > 1) {
                container.removeClass('hidden');
                container.show();
            }  else {
                container.hide();
            }
        });
    });

    /*]]>*/
</script>


</body>
</html>